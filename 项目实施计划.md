# InventoryHub 项目实施计划

## 项目概述

库存管理系统 - 用于管理商品库存、进货、订单的综合管理系统

**技术栈**：
- 前端：Next.js + React + Tailwind CSS + Material UI + Zustand
- 后端：ASP.NET Core (C#) + MySQL
- API：RESTful

**当前状态**：✅ Phase 0 已完成，前后端已成功运行
- 后端：http://localhost:5022
- 前端：http://localhost:3000
- 数据库：inventory_hub (MySQL)
### Phase 0: 项目初始化与环境搭建 ✅ **已完成** (2026-01-01)

#### 后端初始化 ✅
- [x] 创建 ASP.NET Core Web API 项目
- [x] 配置项目结构（Controllers, Models, Services, DTOs, Data）
- [x] 安装必要的 NuGet 包
  - [x] Entity Framework Core
  - [x] MySQL 驱动 (Pomelo.EntityFrameworkCore.MySql)
  - [x] AutoMapper
  - [x] ~~Swashbuckle (Swagger)~~ (暂时跳过，有版本冲突)
- [x] 配置数据库连接字符串
- [x] 创建 DbContext 类
- [x] 创建所有实体模型（Category, Supplier, Product, Purchase, Inventory, Order, OrderDetail）

#### 前端初始化 ✅
- [x] 创建 Next.js 项目
- [x] 配置 Tailwind CSS
- [x] 安装必要的依赖
  - [x] React Hook Form
  - [x] Zod
  - [x] Zustand
  - [x] Axios
  - [x] Material UI (@mui/material, @mui/icons-material, @emotion/react, @emotion/styled)
  - [x] 图表库 (recharts)
  - [x] 日期处理 (date-fns)
  - [x] Excel 导出 (xlsx)
- [x] 配置项目结构（app, components, lib, types, stores）
- [x] 配置环境变量（API 基础 URL、汇率 API）
- [x] 创建 API 客户端 (lib/api.ts)
- [x] 创建汇率工具 (lib/exchangeRate.ts)
- [x] 创建 Material UI 主题 (lib/theme.ts)
- [x] 创建 TypeScript 类型定义 (types/index.ts)

#### 数据库初始化 ✅
- [x] 创建数据库 (inventory_hub)
- [x] 执行数据库迁移/创建表结构
  - [x] categories 表
  - [x] suppliers 表
  - [x] products 表
  - [x] purchases 表
  - [x] inventory 表
  - [x] orders 表
  - [x] order_details 表
- [x] 创建索引和约束
- [ ] 准备测试数据（可选）s 表
  - [ ] inventory 表
  - [ ] orders 表
  - [ ] order_details 表
- [ ] 创建索引和约束
- [ ] 准备测试数据（可选）

---

### Phase 1: 基础数据管理 ⏳ **进行中** (预计 3-4 天)

**目标**：实现最简单的 CRUD 功能，验证整个技术栈的联通性

#### 1.1 商品分类管理 🎯 **推荐从这里开始**

**后端任务**：
- [ ] 创建 Category 实体模型
- [ ] 创建 CategoryDto
- [ ] 创建 CategoryService（业务逻辑）
- [ ] 创建 CategoryController（API 端点）
  - [ ] GET /api/categories - 获取所有分类
  - [ ] POST /api/categories - 创建分类
  - [ ] PUT /api/categories/{id} - 更新分类
  - [ ] DELETE /api/categories/{id} - 软删除分类
- [ ] 添加验证逻辑（分类名唯一、删除前检查关联商品）

**前端任务**：
- [ ] 创建分类列表页面组件 `/categories`
- [ ] 创建分类表格组件
- [ ] 创建新增/编辑分类对话框组件
- [ ] 实现 CRUD 功能
- [ ] 添加表单验证
- [ ] 添加删除确认对话框

**测试**：
- [ ] API 测试（Postman/Swagger）
- [ ] 前端功能测试

---

#### 1.2 进货渠道管理

**后端任务**：
- [ ] 创建 Supplier 实体模型
- [ ] 创建 SupplierDto
- [ ] 创建 SupplierService
- [ ] 创建 SupplierController
  - [ ] GET /api/suppliers
  - [ ] POST /api/suppliers
  - [ ] PUT /api/suppliers/{id}
  - [ ] DELETE /api/suppliers/{id}
- [ ] 添加验证逻辑（渠道名唯一、删除前检查关联进货）

**前端任务**：
- [ ] 创建进货渠道页面 `/suppliers`
- [ ] 复用分类页面的组件架构
- [ ] 实现 CRUD 功能

**测试**：
- [ ] API 测试
- [ ] 前端功能测试

---

#### 1.3 商品管理

**后端任务**：
- [ ] 创建 Product 实体模型
- [ ] 创建 ProductDto
- [ ] 创建 ProductService
- [ ] 创建 ProductController
  - [ ] GET /api/products
  - [ ] GET /api/products/{id}
  - [ ] POST /api/products
  - [ ] PUT /api/products/{id}
  - [ ] DELETE /api/products/{id}
- [ ] 添加分类筛选

**前端任务**：
- [ ] 创建商品列表页面 `/products`
- [ ] 创建商品表格
- [ ] 创建商品表单
- [ ] 实现分类筛选功能
- [ ] 添加表单验证

**测试**：
- [ ] CRUD 功能测试
- [ ] 分类关联测试

---

### Phase 2: 进货和库存管理 (预计 4-5 天)

#### 2.1 进货管理

**后端任务**：
- [ ] 创建 Purchase 实体模型
- [ ] 创建 PurchaseDto
- [ ] 创建 PurchaseService
- [ ] 创建 PurchaseController
  - [ ] GET /api/purchases
  - [ ] GET /api/purchases/{id}
  - [ ] POST /api/purchases
  - [ ] PUT /api/purchases/{id}
  - [ ] DELETE /api/purchases/{id}
- [ ] 实现日期范围筛选
- [ ] 添加进货单号唯一性验证

**前端任务**：
- [ ] 创建进货列表页面 `/purchases`
- [ ] 创建进货表格
- [ ] 创建进货表单（包含汇率计算）
- [ ] 实现日期范围筛选
- [ ] 实现点击跳转到在库列表功能
- [ ] 汇率 LocalStorage 保存功能

**测试**：
- [ ] 汇率计算测试
- [ ] 日期筛选测试

---

#### 2.2 在库管理

**后端任务**：
- [ ] 创建 Inventory 实体模型
- [ ] 创建 InventoryDto
- [ ] 创建 InventoryService
- [ ] 创建 InventoryController
  - [ ] GET /api/inventory
  - [ ] GET /api/inventory?purchaseId={id}
  - [ ] POST /api/inventory/batch - 批量创建在库记录
  - [ ] PUT /api/inventory/{id}
  - [ ] DELETE /api/inventory/{id}
- [ ] 实现单件成本自动计算
- [ ] 实现进货支出总和验证
- [ ] 添加库存数量约束（>= 0）

**前端任务**：
- [ ] 创建在库列表页面 `/inventory`
- [ ] 创建在库表格（支持多行编辑）
- [ ] 实现进货单号下拉选择
- [ ] 实现实时计算：
  - [ ] 单件成本计算
  - [ ] 支出总和计算
  - [ ] 差额显示
- [ ] 实现保存按钮激活逻辑（差额 = 0）
- [ ] 实现批量保存功能
- [ ] 添加商品筛选

**测试**：
- [ ] 批量创建测试
- [ ] 成本计算准确性测试
- [ ] 支出总和验证测试

---

### Phase 3: 订单核心功能 (预计 5-6 天)

#### 3.1 订单列表

**后端任务**：
- [ ] 创建 Order 实体模型
- [ ] 创建 OrderDto
- [ ] 创建 OrderService
- [ ] 创建 OrderController
  - [ ] GET /api/orders
  - [ ] GET /api/orders/{id}
  - [ ] POST /api/orders
  - [ ] PUT /api/orders/{id}
  - [ ] DELETE /api/orders/{id} - 软删除
- [ ] 实现排序功能
- [ ] 实现筛选功能（订单号、日期范围）
- [ ] 实现利润计算

**前端任务**：
- [ ] 创建订单列表页面 `/orders`
- [ ] 创建订单表格
  - [ ] 显示订单编号、收入、成本、利润、交易时间
  - [ ] 成本 NULL 显示"未输入"
  - [ ] 成本 NULL 默认排在最前
- [ ] 实现排序功能（多列排序）
- [ ] 实现筛选功能
- [ ] 实现导出功能（Excel/CSV）
- [ ] 点击成本列跳转到订单详细编辑页

**测试**：
- [ ] 排序测试
- [ ] 筛选测试
- [ ] 导出功能测试

---

#### 3.2 订单详细编辑页（核心功能）

**后端任务**：
- [ ] 创建 OrderDetail 实体模型
- [ ] 创建 OrderDetailDto
- [ ] 创建 OrderDetailService
- [ ] 创建 OrderDetailController
  - [ ] GET /api/orders/{orderId}/details
  - [ ] POST /api/orders/{orderId}/details/batch - 批量保存
- [ ] 实现复杂的保存逻辑（事务处理）：
  - [ ] 库存回滚
  - [ ] 删除原订单详细
  - [ ] 添加新订单详细
  - [ ] 扣减库存
  - [ ] 更新订单总成本
- [ ] 实现库存验证（防止超卖）
- [ ] 实现并发控制（行锁）

**前端任务**：
- [ ] 创建订单详细编辑页 `/orders/[id]/edit`
- [ ] 创建订单信息卡片（只读）
- [ ] 创建订单详细表格（可编辑）
  - [ ] 商品名下拉（二级菜单：分类 → 商品 + 库存）
  - [ ] 进货单价自动填充
  - [ ] 数量输入（超库存标红）
  - [ ] 包装成本、其他成本输入
  - [ ] 小计成本自动计算
  - [ ] 备注输入
  - [ ] 删除按钮
- [ ] 实现 Zustand 状态管理
- [ ] 实现实时计算：
  - [ ] 订单总成本
  - [ ] 订单总利润
- [ ] 实现保存按钮激活逻辑
- [ ] 实现乐观 UI 更新
- [ ] 实现取消确认对话框
- [ ] 追加按钮功能

**测试**：
- [ ] 库存扣减测试
- [ ] 事务回滚测试
- [ ] 并发测试
- [ ] 表单验证测试

---

#### 3.3 订单详细查询页（只读）

**后端任务**：
- [ ] 扩展 OrderDetailController
  - [ ] GET /api/order-details - 获取所有订单详细（支持筛选）
- [ ] 实现多条件筛选
- [ ] 实现分页

**前端任务**：
- [ ] 创建订单详细查询页 `/order-details`
- [ ] 创建订单详细表格（只读）
- [ ] 实现多条件筛选
- [ ] 实现分页（20-50 条/页）
- [ ] 实现导出功能

**测试**：
- [ ] 筛选测试
- [ ] 分页测试

---

### Phase 4: Dashboard 与统计 (预计 2-3 天)

**后端任务**：
- [ ] 创建 DashboardController
  - [ ] GET /api/dashboard/total-stock-value - 总库存价值
  - [ ] GET /api/dashboard/monthly-profit - 月度利润
  - [ ] GET /api/dashboard/low-stock-alerts - 低库存预警
  - [ ] GET /api/dashboard/top-products - 热销商品
  - [ ] GET /api/dashboard/monthly-order-count - 月度订单数

**前端任务**：
- [ ] 创建主页 Dashboard `/`
- [ ] 创建导航菜单
- [ ] 创建数据统计面板
  - [ ] 总库存价值卡片
  - [ ] 月度利润图表（柱状图）
  - [ ] 低库存预警列表
  - [ ] 热销商品 Top 10
  - [ ] 本月订单数量
- [ ] 集成图表库（Chart.js / Recharts）

**测试**：
- [ ] 统计数据准确性测试
- [ ] 图表显示测试

---

### Phase 5: 优化与完善 (预计 3-4 天)

#### 5.1 性能优化
- [ ] 后端
  - [ ] 添加数据库索引优化
  - [ ] 实现 API 响应缓存
  - [ ] 优化查询（避免 N+1 问题）
  - [ ] 添加分页支持
- [ ] 前端
  - [ ] 实现虚拟滚动（大数据列表）
  - [ ] 添加加载状态
  - [ ] 实现防抖/节流
  - [ ] 代码分割和懒加载

#### 5.2 用户体验优化
- [ ] 添加全局错误处理
- [ ] 添加成功/失败提示（Toast）
- [ ] 添加加载动画
- [ ] 实现响应式设计（移动端适配）
- [ ] 添加键盘快捷键
- [ ] 添加操作确认对话框

#### 5.3 数据导出
- [ ] 实现 Excel 导出
- [ ] 实现 CSV 导出
- [ ] 支持自定义导出字段

#### 5.4 权限管理（可选）
- [ ] 用户登录/注册
- [ ] JWT 认证
- [ ] 角色权限控制
- [ ] API 权限验证

#### 5.5 日志与审计（可选）
- [ ] 操作日志记录
- [ ] 错误日志记录
- [ ] 审计追踪

---

## 技术实现细节

### 后端项目结构
```
InventoryHub.API/
├── Controllers/          # API 控制器
│   ├── CategoriesController.cs
│   ├── SuppliersController.cs
│   ├── ProductsController.cs
│   ├── PurchasesController.cs
│   ├── InventoryController.cs
│   ├── OrdersController.cs
│   ├── OrderDetailsController.cs
│   └── DashboardController.cs
├── Models/              # 数据库实体模型
│   ├── Category.cs
│   ├── Supplier.cs
│   ├── Product.cs
│   ├── Purchase.cs
│   ├── Inventory.cs
│   ├── Order.cs
│   └── OrderDetail.cs
├── DTOs/                # 数据传输对象
│   ├── CategoryDto.cs
│   ├── SupplierDto.cs
│   └── ...
├── Services/            # 业务逻辑层
│   ├── ICategoryService.cs
│   ├── CategoryService.cs
│   └── ...
├── Data/                # 数据访问层
│   ├── AppDbContext.cs
│   └── Repositories/
├── Mappings/            # AutoMapper 配置
│   └── MappingProfile.cs
├── Middleware/          # 中间件
│   └── ErrorHandlerMiddleware.cs
└── Program.cs           # 应用入口
```

### 前端项目结构
```
inventory-hub-frontend/
├── app/                 # Next.js App Router
│   ├── page.tsx         # Dashboard
│   ├── categories/
│   │   └── page.tsx
│   ├── suppliers/
│   │   └── page.tsx
│   ├── products/
│   │   └── page.tsx
│   ├── purchases/
│   │   └── page.tsx
│   ├── inventory/
│   │   └── page.tsx
│   ├── orders/
│   │   ├── page.tsx
│   │   ├── [id]/
│   │   │   └── edit/
│   │   │       └── page.tsx
│   └── order-details/
│       └── page.tsx
├── components/          # React 组件
│   ├── ui/              # 基础 UI 组件
│   ├── categories/
│   ├── suppliers/
│   ├── products/
│   ├── purchases/
│   ├── inventory/
│   ├── orders/
│   └── layout/
│       ├── Header.tsx
│       ├── Sidebar.tsx
│       └── Layout.tsx
├── lib/                 # 工具函数
│   ├── api.ts           # API 客户端
│   ├── utils.ts
│   └── constants.ts
├── stores/              # Zustand 状态管理
│   ├── orderDetailStore.ts
│   └── inventoryStore.ts
├── types/               # TypeScript 类型定义
│   └── index.ts
└── styles/
    └── globals.css
```

---

## 数据库创建脚本

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS inventory_hub CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

USE inventory_hub;

-- 1. 商品分类表
CREATE TABLE categories (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_deleted BOOLEAN DEFAULT FALSE,
    UNIQUE KEY unique_category_name (name, is_deleted)
);

-- 2. 进货渠道表
CREATE TABLE suppliers (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_deleted BOOLEAN DEFAULT FALSE,
    UNIQUE KEY unique_supplier_name (name, is_deleted)
);

-- 3. 商品表（商品不需要图片）
CREATE TABLE products (
    id INT AUTO_INCREMENT PRIMARY KEY,
    category_id INT NOT NULL,
    name VARCHAR(200) NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_deleted BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (category_id) REFERENCES categories(id),
    INDEX idx_category_id (category_id)
);

-- 4. 进货表
CREATE TABLE purchases (
    id INT AUTO_INCREMENT PRIMARY KEY,
    supplier_id INT NOT NULL,
    purchase_date DATE NOT NULL,
    purchase_no VARCHAR(100) NOT NULL,
    total_amount DECIMAL(15,2) NOT NULL,
    currency_type VARCHAR(10) NOT NULL,
    exchange_rate DECIMAL(10,4) NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_deleted BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (supplier_id) REFERENCES suppliers(id),
    UNIQUE KEY unique_purchase_no (purchase_no),
    INDEX idx_supplier_id (supplier_id),
    INDEX idx_purchase_date (purchase_date)
);

-- 5. 在库表
CREATE TABLE inventory (
    id INT AUTO_INCREMENT PRIMARY KEY,
    product_id INT NOT NULL,
    purchase_id INT NOT NULL,
    purchase_amount DECIMAL(15,2) NOT NULL,
    purchase_quantity INT NOT NULL CHECK (purchase_quantity > 0),
    unit_cost DECIMAL(15,2) NOT NULL,
    stock_quantity INT NOT NULL CHECK (stock_quantity >= 0),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_deleted BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (product_id) REFERENCES products(id),
    FOREIGN KEY (purchase_id) REFERENCES purchases(id),
    INDEX idx_product_id (product_id),
    INDEX idx_purchase_id (purchase_id)
);

-- 6. 订单表
CREATE TABLE orders (
    id INT AUTO_INCREMENT PRIMARY KEY,
    order_no VARCHAR(100) NOT NULL,
    image_url VARCHAR(500) NULL,
    revenue DECIMAL(15,2) NOT NULL,
    total_cost DECIMAL(15,2) NULL,
    transaction_time DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_deleted BOOLEAN DEFAULT FALSE,
    UNIQUE KEY unique_order_no (order_no),
    INDEX idx_transaction_time (transaction_time),
    INDEX idx_orders_cost_time (total_cost, transaction_time)
);

-- 7. 订单详细表
CREATE TABLE order_details (
    id INT AUTO_INCREMENT PRIMARY KEY,
    order_id INT NOT NULL,
    inventory_id INT NOT NULL,
    product_id INT NOT NULL,
    unit_price DECIMAL(15,2) NOT NULL,
    quantity INT NOT NULL CHECK (quantity > 0),
    packaging_cost DECIMAL(15,2) DEFAULT 0,
    other_cost DECIMAL(15,2) DEFAULT 0,
    subtotal_cost DECIMAL(15,2) NOT NULL,
    notes TEXT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_deleted BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (order_id) REFERENCES orders(id),
    FOREIGN KEY (inventory_id) REFERENCES inventory(id),
    FOREIGN KEY (product_id) REFERENCES products(id),
    INDEX idx_order_id (order_id),
    INDEX idx_inventory_id (inventory_id),
    INDEX idx_product_id (product_id),
    INDEX idx_order_details_order_inventory (order_id, inventory_id)
);
```

---

## 开发时间估算

| 阶段 | 预计时间 | 关键里程碑 |
|------|----------|------------|
| Phase 0: 环境搭建 | 1-2 天 | 项目初始化完成、数据库创建成功 |
| Phase 1: 基础数据管理 | 3-4 天 | 分类、渠道、商品 CRUD 完成 |
| Phase 2: 进货和库存 | 4-5 天 | 进货和在库管理完成、成本计算正确 |
| Phase 3: 订单核心功能 | 5-6 天 | 订单详细编辑功能完成、库存扣减正确 |
| Phase 4: Dashboard | 2-3 天 | 统计数据展示完成 |
| Phase 5: 优化完善 | 3-4 天 | 性能优化、用户体验提升 |
| **总计** | **18-24 天** | 全功能系统上线 |

---

## 风险与挑战

### 技术风险
1. **并发控制**：订单保存时的库存扣减需要严格的事务和锁机制
2. **性能问题**：订单详细页的复杂计算可能影响性能
3. **数据一致性**：进货支出分配需要确保总和正确

### 业务风险
1. **用户体验**：订单详细编辑页的交互较复杂，需要充分测试
2. **数据准确性**：成本、汇率计算需要高精度

### 解决方案
- 使用数据库事务和行锁
- 前端实现乐观 UI 更新
- 充分的单元测试和集成测试
- 使用 Decimal 类型处理金额计算

---

## 后续扩展建议

1. **多语言支持**：国际化 (i18n)
2. **移动端 App**：React Native 或原生开发
3. **数据分析**：更详细的销售分析、趋势预测
4. **供应商管理**：供应商评分、对账功能
5. **库存预警**：自动补货提醒
6. **批量操作**：批量导入商品、订单
7. **API 集成**：对接电商平台 API

---

## 项目配置决策（已确认）

1. ✅ **用户系统**: 单用户使用，无需登录和权限管理
2. ✅ **图片存储**: 
   - 商品图片：不需要（已从数据库设计中移除）
   - 订单图片：已存储在云端，数据库仅存储 URL
3. ✅ **汇率数据**: 通过 API 自动获取当天的 RMB 对 JPY 汇率
4. ✅ **开发顺序**: 按模块并行开发
5. ✅ **MySQL 数据库**: 已安装，需创建项目数据库
6. ✅ **UI 组件库**: Material UI
7. ✅ **移动端**: 不需要适配
8. ✅ **上线时间**: 无固定期限
